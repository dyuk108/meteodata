# База метеорологических данных в формате DuckDB

Данный репозиторий является частью проекта ["Погода для садовода"](https://pogoda.dyuk108.ru/), в котором метеорологические данные
представлены по метеостанциям в виде графиков и диаграмм. Подразумевалось, что садовод выберет на карте близлежащую метеостанцию,
посмотрит графики и сделает выводы о сроках сезонных работ. 

> [!NOTE]
> Данные были [взяты из открытых источников](http://meteo.ru/data/).
> За основы взяты "Основные метеорологические параметры (срочные данные)" (архив `Srok8c.zip`) и
> "Характеристики снежного покрова (ежедневные данные)" (архив `Snow.zip`),
> разработанные в ВНИИГМИ-МЦД.
> Авторы: канд. физ. мат. наук В.М. Веселов, канд. техн. наук И.Р. Прибыльская.

В данном репозитории приведены исходные коды скриптов, которые осущесвляют преобразования файлов
этих двух архивов сначала в файлы CSV (`src/dat2csv.py`), которые затем преобразуются в базу данных DuckDB (`src/csv2db.py`).

## Цель данного мини-проекта

1. Используя полученный файл БД можно проводить школьные уроки по составлению запросов SQL,
используя написанные скрипты Python. Как известно, [DuckDB](https://duckdb.org/) - встраиваемая
колоночная БД, ориентированная на аналитику.

2. Замечено, что садоводы не склонны к чтению метеорологических графиков. Принято решение
заменить выдачу для каждой метеостанцией аналитической сводкой. Для чего удобнее
использовать SQL-запросы, нежели напрямую работать с файлами `.dat`. Подобные проекты
может сделать каждый, кто умеет программировать на Python.

## Скачать базу даных

[Ссылка для скачивания](https://disk.yandex.ru/d/f6eCXC2OR4GRIw) (1,1 Гб)

> [!NOTE]
> База актуальна на январь 2025 г.

## Таблицы и поля БД

### Таблица `synoptic`

Срочные метеорологические данные. "Срок" - это период времени в 1/8 суток (3 часа). 
То есть периодичность наблюдений составляет 3 часа. 
Из исходных файлов взяты только те поля, которые используютсядля учебных целей.

| Поле | Тип данных | Описание |
| --- | --- | --- |
| `date` | `TIMESTAMP` | Дата, время |
| `station_id` | `INTEGER` | Индекс станции |
| `weather_code` | `INTEGER` | Код погоды между сроками |
| `wind_direction` | `INTEGER` | Направление ветра |
| `wind_speed` | `INTEGER` | Средняя скорость ветра, м/с |
| `rain` | `FLOAT` | Сумма осадков, мм |
| `ground_temperature` | `FLOAT` | Температура поверхности почвы |
| `temperature` | `FLOAT` | Температура воздуха по сухому термометру |
| `humidity` | `INTEGER` | Относительная влажность воздуха |
| `pressure` | `INTEGER` | Атмосферное давление на уровне станции |

### Таблица `daily`

Посуточные данные. То есть наблюдения производились раз в сутки

| Поле | Тип данных | Описание |
| --- | --- | --- |
| `date` | `DATE` | Дата |
| `station_id` | `INTEGER` | Индекс станции |
| `snow` | `INTEGER` | Уровень снежного покрова (см.) |

### Таблица `stations`

Информация о метеостанциях (из архива `Srok8c.zip`).

> [!WARNING]
> В исходном файле долгота самых восточных метеостанций России имеет значение более 180 градусов, что неправильно.
> Исправлено на отрицательную долготу, это соответствует западному полушарию Земли.

> [!NOTE]
> Для каждой метеостанции добавлен код региона. Названия регионов - см. далее.

| Поле | Тип данных | Описание |
| --- | --- | --- |
| `station_id`, `INTEGER` | Индекс станции |
| `name` | `VARCHAR` | Название станции |
| `lat` | `FLOAT` | Широта |
| `lon` | `FLOAT` | Долгота |
| `h` | `INTEGER` | Высота над уровнем моря |
| `province_id` | `INTEGER` | Код региона |

### Таблица `provinces`

Названия регионов. Цифровые значения указаны в соответствии с кодами для автомобильных номеров.

| Поле | Тип данных | Описание |
| --- | --- | --- |
| `province_id` | `INTEGER` | Код региона |
| `name` | `VARCHAR` | Название региона |

## Примеры запросов

Приведены в папке `examples`.

### Список метеостанций с названием регионов

```
import duckdb

# Подключаемся к файлу базы данных (создастся, если не существует)
con = duckdb.connect('meteodata.db')

# Запрос с ответом в формате датафрейма Pandas
res = con.execute("""SELECT stations.station_id, stations.name, provinces.name AS province
FROM stations
JOIN provinces ON provinces.province_id = stations.province_id""").fetchdf()
print(res)

con.close()
```

### Список дат последних весенних заморозков по годам

```
import duckdb

beg_year = 2015 # первый год в последовательности
end_year = 2024 # последний год в последовательности
station = 27625

# Подключаемся к файлу базы данных (создастся, если не существует)
con = duckdb.connect('meteodata.db')

# Запрос: для каждого года находится последняя дата, 
# когда минимальная температура опускалась до 0 или ниже градусов.
query = f"""WITH years AS (
SELECT UNNEST(GENERATE_SERIES({beg_year}, {end_year})) as year
)
SELECT 
    (SELECT MAX(date::DATE) 
     FROM synoptic 
     WHERE station_id = {station}
       AND EXTRACT(YEAR FROM date) = y.year
       AND temperature <= 0
       AND date <= MAKE_DATE(y.year, 7, 1)) as last_cold_date
FROM years y
ORDER BY y.year;
"""

df = con.execute(query).df()
print(df)

con.close()
```

Удачного использования! Дмитрий Клыков, [dyuk108.ru](https://dyuk108.ru). 2025.
